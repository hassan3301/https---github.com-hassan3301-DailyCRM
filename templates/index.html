<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Daily — QBO Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              yellow: { 400:"#FFD700", 500:"#FFC107", 600:"#FF8F00" },
            },
            fontFamily: { inter: ["Inter","sans-serif"] }
          }
        }
      };
    </script>
    <style>
      body { font-family: "Inter", sans-serif; }
      .chat-message { animation: slideInUp 0.2s ease-out; }
      @keyframes slideInUp {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      /* nicer lists inside agent markdown */
      .prose ul { list-style: disc; padding-left: 1.5rem; }
      .prose ol { list-style: decimal; padding-left: 1.5rem; }
      .prose li { margin: .25rem 0; }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen font-inter text-sm">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
      <div class="px-3 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2 sm:space-x-4">
            <img src="{{ url_for('static', filename='Daily Logo.png') }}" alt="Logo" class="h-10 sm:h-12 w-auto"/>
            <div class="hidden sm:block">
              <p class="text-xs text-gray-500">Demo</p>
              <p class="text-sm font-semibold text-gray-900">QBO Agent</p>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <div class="text-right hidden sm:block">
              <p class="text-xs text-gray-500">Welcome,</p>
              <p class="text-sm font-semibold text-gray-900">{{ session.get("user_name", "User") }}</p>
            </div>
            <form action="{{ url_for('logout') }}" method="post">
              <button type="submit"
                class="px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-900 text-white text-xs rounded hover:bg-gray-800 transition-colors font-medium">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <!-- Chat Layout -->
    <main class="h-[calc(100vh-60px)] sm:h-[calc(100vh-68px)] flex flex-col">
      <!-- Messages -->
      <div id="chatMessagesArea" class="flex-1 overflow-y-auto px-3 sm:px-6 py-4">
        <div id="chatMessages" class="space-y-3 sm:space-y-4">
          <!-- (Optional) Starter message -->
          <div class="chat-message">
            <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4 max-w-[85%] prose prose-sm">
              <p class="m-0"><strong>Daily Agent (QBO):</strong> Ask me about your QuickBooks data. For example:
              </p>
              <ul class="mt-2">
                <li>“Show monthly revenue for 2024.”</li>
                <li>“List overdue invoices and totals.”</li>
                <li>“Top 5 expense categories year-to-date.”</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Bar -->
      <div class="border-t border-gray-200 bg-white shadow-[0_-4px_12px_rgba(0,0,0,0.05)]">
        <div class="max-w-5xl mx-auto px-3 sm:px-6 py-3">
          <form id="chatForm" class="flex items-center space-x-3">
            <input
              id="messageInput" name="message" autocomplete="off"
              placeholder="Ask your AI assistant about your QuickBooks data…"
              class="flex-1 p-3 pr-12 border border-gray-300 rounded-full text-sm
                     focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 bg-gray-50 focus:bg-white"/>
            <button type="submit"
              class="w-9 h-9 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition-colors flex items-center justify-center">
              <span class="text-sm">→</span>
            </button>
          </form>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      const chatForm     = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const messagesArea = document.getElementById("chatMessagesArea");

      function appendMessage(role, textAsHtmlOrMd) {
        const wrapper = document.createElement("div");
        wrapper.className = "chat-message flex " + (role === "user" ? "justify-end" : "justify-start");

        if (role === "user") {
          wrapper.innerHTML = `
            <div class="bg-yellow-500 text-white rounded-lg p-3 sm:p-3 max-w-[85%]">
              <p class="m-0">${escapeHtml(textAsHtmlOrMd)}</p>
            </div>`;
        } else {
          const html = isLikelyHtml(textAsHtmlOrMd) ? textAsHtmlOrMd : marked.parse(textAsHtmlOrMd);
          wrapper.innerHTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4 max-w-[85%] prose prose-sm">
              ${html}
            </div>`;
        }

        chatMessages.appendChild(wrapper);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function isLikelyHtml(s) {
        return typeof s === "string" && /<\/?[a-z][\s\S]*>/i.test(s);
      }
      function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      async function sendToAgent(msg) {
        try {
          const resp = await fetch("/chat", {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: msg })
          });
          const body = await resp.json();
          if (resp.ok) {
            // Your /chat returns HTML converted from Markdown already
            appendMessage("assistant", body.assistant || "No response.");
          } else {
            appendMessage("assistant", "⚠️ " + (body.error || "Error"));
          }
        } catch (e) {
          appendMessage("assistant", "⚠️ Network error.");
        }
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const txt = messageInput.value.trim();
        if (!txt) return;
        appendMessage("user", txt);
        messageInput.value = "";
        sendToAgent(txt);
      });
    </script>
  </body>
</html>
